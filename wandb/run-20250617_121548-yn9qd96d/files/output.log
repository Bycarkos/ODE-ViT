Config of the encoder: <class 'transformers.models.vit.modeling_vit.ViTModel'> is overwritten by shared encoder config: ViTConfig {
  "attention_probs_dropout_prob": 0.0,
  "encoder_stride": 16,
  "hidden_act": "gelu",
  "hidden_dropout_prob": 0.0,
  "hidden_size": 768,
  "image_size": 384,
  "initializer_range": 0.02,
  "intermediate_size": 3072,
  "layer_norm_eps": 1e-12,
  "model_type": "vit",
  "num_attention_heads": 12,
  "num_channels": 3,
  "num_hidden_layers": 1,
  "patch_size": 16,
  "pooler_act": "tanh",
  "pooler_output_size": 768,
  "qkv_bias": false,
  "torch_dtype": "float32",
  "transformers_version": "4.51.1"
}

Config of the decoder: <class 'transformers.models.trocr.modeling_trocr.TrOCRForCausalLM'> is overwritten by shared decoder config: TrOCRConfig {
  "activation_dropout": 0.0,
  "activation_function": "relu",
  "add_cross_attention": true,
  "attention_dropout": 0.0,
  "bos_token_id": 0,
  "classifier_dropout": 0.0,
  "cross_attention_hidden_size": 768,
  "d_model": 1024,
  "decoder_attention_heads": 16,
  "decoder_ffn_dim": 4096,
  "decoder_layerdrop": 0.0,
  "decoder_layers": 12,
  "decoder_start_token_id": 2,
  "dropout": 0.1,
  "eos_token_id": 2,
  "init_std": 0.02,
  "is_decoder": true,
  "layernorm_embedding": false,
  "max_position_embeddings": 1024,
  "model_type": "trocr",
  "pad_token_id": 1,
  "scale_embedding": true,
  "tie_word_embeddings": false,
  "torch_dtype": "float32",
  "transformers_version": "4.51.1",
  "use_cache": false,
  "use_learned_position_embeddings": false,
  "vocab_size": 50265
}

Some weights of the model checkpoint at checkpoints/TrOCR_Esposalles_reduced.pt were not used when initializing VisionEncoderDecoderModel: ['encoder.encoder.layer.1.attention.attention.key.weight', 'encoder.encoder.layer.1.attention.attention.query.weight', 'encoder.encoder.layer.1.attention.attention.value.weight', 'encoder.encoder.layer.1.attention.output.dense.bias', 'encoder.encoder.layer.1.attention.output.dense.weight', 'encoder.encoder.layer.1.intermediate.dense.bias', 'encoder.encoder.layer.1.intermediate.dense.weight', 'encoder.encoder.layer.1.layernorm_after.bias', 'encoder.encoder.layer.1.layernorm_after.weight', 'encoder.encoder.layer.1.layernorm_before.bias', 'encoder.encoder.layer.1.layernorm_before.weight', 'encoder.encoder.layer.1.output.dense.bias', 'encoder.encoder.layer.1.output.dense.weight', 'encoder.encoder.layer.10.attention.attention.key.weight', 'encoder.encoder.layer.10.attention.attention.query.weight', 'encoder.encoder.layer.10.attention.attention.value.weight', 'encoder.encoder.layer.10.attention.output.dense.bias', 'encoder.encoder.layer.10.attention.output.dense.weight', 'encoder.encoder.layer.10.intermediate.dense.bias', 'encoder.encoder.layer.10.intermediate.dense.weight', 'encoder.encoder.layer.10.layernorm_after.bias', 'encoder.encoder.layer.10.layernorm_after.weight', 'encoder.encoder.layer.10.layernorm_before.bias', 'encoder.encoder.layer.10.layernorm_before.weight', 'encoder.encoder.layer.10.output.dense.bias', 'encoder.encoder.layer.10.output.dense.weight', 'encoder.encoder.layer.11.attention.attention.key.weight', 'encoder.encoder.layer.11.attention.attention.query.weight', 'encoder.encoder.layer.11.attention.attention.value.weight', 'encoder.encoder.layer.11.attention.output.dense.bias', 'encoder.encoder.layer.11.attention.output.dense.weight', 'encoder.encoder.layer.11.intermediate.dense.bias', 'encoder.encoder.layer.11.intermediate.dense.weight', 'encoder.encoder.layer.11.layernorm_after.bias', 'encoder.encoder.layer.11.layernorm_after.weight', 'encoder.encoder.layer.11.layernorm_before.bias', 'encoder.encoder.layer.11.layernorm_before.weight', 'encoder.encoder.layer.11.output.dense.bias', 'encoder.encoder.layer.11.output.dense.weight', 'encoder.encoder.layer.2.attention.attention.key.weight', 'encoder.encoder.layer.2.attention.attention.query.weight', 'encoder.encoder.layer.2.attention.attention.value.weight', 'encoder.encoder.layer.2.attention.output.dense.bias', 'encoder.encoder.layer.2.attention.output.dense.weight', 'encoder.encoder.layer.2.intermediate.dense.bias', 'encoder.encoder.layer.2.intermediate.dense.weight', 'encoder.encoder.layer.2.layernorm_after.bias', 'encoder.encoder.layer.2.layernorm_after.weight', 'encoder.encoder.layer.2.layernorm_before.bias', 'encoder.encoder.layer.2.layernorm_before.weight', 'encoder.encoder.layer.2.output.dense.bias', 'encoder.encoder.layer.2.output.dense.weight', 'encoder.encoder.layer.3.attention.attention.key.weight', 'encoder.encoder.layer.3.attention.attention.query.weight', 'encoder.encoder.layer.3.attention.attention.value.weight', 'encoder.encoder.layer.3.attention.output.dense.bias', 'encoder.encoder.layer.3.attention.output.dense.weight', 'encoder.encoder.layer.3.intermediate.dense.bias', 'encoder.encoder.layer.3.intermediate.dense.weight', 'encoder.encoder.layer.3.layernorm_after.bias', 'encoder.encoder.layer.3.layernorm_after.weight', 'encoder.encoder.layer.3.layernorm_before.bias', 'encoder.encoder.layer.3.layernorm_before.weight', 'encoder.encoder.layer.3.output.dense.bias', 'encoder.encoder.layer.3.output.dense.weight', 'encoder.encoder.layer.4.attention.attention.key.weight', 'encoder.encoder.layer.4.attention.attention.query.weight', 'encoder.encoder.layer.4.attention.attention.value.weight', 'encoder.encoder.layer.4.attention.output.dense.bias', 'encoder.encoder.layer.4.attention.output.dense.weight', 'encoder.encoder.layer.4.intermediate.dense.bias', 'encoder.encoder.layer.4.intermediate.dense.weight', 'encoder.encoder.layer.4.layernorm_after.bias', 'encoder.encoder.layer.4.layernorm_after.weight', 'encoder.encoder.l
- This IS expected if you are initializing VisionEncoderDecoderModel from the checkpoint of a model trained on another task or with another architecture (e.g. initializing a BertForSequenceClassification model from a BertForPreTraining model).
- This IS NOT expected if you are initializing VisionEncoderDecoderModel from the checkpoint of a model that you expect to be exactly identical (initializing a BertForSequenceClassification model from a BertForSequenceClassification model).
/home/cboned/Projects/OCR-Koopman/experiment_ocr_lkis_ctc.py:38: FutureWarning: You are using `torch.load` with `weights_only=False` (the current default value), which uses the default pickle module implicitly. It is possible to construct malicious pickle data which will execute arbitrary code during unpickling (See https://github.com/pytorch/pytorch/blob/main/SECURITY.md#untrusted-models for more details). In a future release, the default value for `weights_only` will be flipped to `True`. This limits the functions that could be executed during unpickling. Arbitrary objects will no longer be allowed to be loaded via this mode unless they are explicitly allowlisted by the user via `torch.serialization.add_safe_globals`. We recommend you start setting `weights_only=True` for any use case where you don't have full control of the loaded file. Please open an issue on GitHub for any issues related to this experimental feature.
  keys = torch.load("checkpoints/TrOCR_Esposalles_CTC_With_Q_2.pt")
Reduced model loaded
Loaded keys: <All keys matched successfully>
LKIS model loaded
Starting training procedure
Evaluating to get the baseline
val Procedure: 24it [00:18,  1.28it/s]
Training Epoch 1: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 345/345 [11:19<00:00,  1.97s/it]
Validation Loss Epoch: 0 Value: 79.3061767578125 Optimal_loss: 79.3061767578125
val Procedure: 9it [00:07,  1.17it/s]████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 345/345 [11:19<00:00,  1.71s/it]
Loss Epoch: 1 Value: 28.835175584337588
Training Epoch 2: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 345/345 [11:33<00:00,  2.01s/it]
val Procedure: 9it [00:07,  1.17it/s]████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 345/345 [11:33<00:00,  1.74s/it]
Loss Epoch: 2 Value: 15.004883686298836
Training Epoch 3: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 345/345 [11:31<00:00,  2.01s/it]
Model Updated: Validation Loss Epoch: 0 Value: 5.882586669921875 Optimal_loss: 5.882586669921875
val Procedure: 9it [00:07,  1.15it/s]████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 345/345 [11:31<00:00,  1.74s/it]
Loss Epoch: 3 Value: 10.964675761148523
Training Epoch 4: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 345/345 [11:31<00:00,  2.00s/it]
Model Updated: Validation Loss Epoch: 0 Value: 5.68993558883667 Optimal_loss: 5.68993558883667
val Procedure: 9it [00:07,  1.16it/s]████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 345/345 [11:31<00:00,  1.74s/it]
Loss Epoch: 4 Value: 8.04202375399568
Training Epoch 5: 100%|███████████████████████████████████████████████████████████████████████████| 345/345 [11:31<00:00,  2.00s/it]                                | 4/99 [46:30<18:26:34, 698.89s/it]
val Procedure: 9it [00:07,  1.17it/s]█████████████████████████████████████████████████████████████| 345/345 [11:31<00:00,  1.74s/it]
Loss Epoch: 5 Value: 6.483476281489577
Training Epoch 6: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 345/345 [11:31<00:00,  2.00s/it]
val Procedure: 9it [00:07,  1.15it/s]████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 345/345 [11:31<00:00,  1.74s/it]
Loss Epoch: 6 Value: 5.506409391881137
Training Epoch 7: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 345/345 [11:31<00:00,  2.01s/it]
Model Updated: Validation Loss Epoch: 0 Value: 4.16408143043518 Optimal_loss: 4.16408143043518
val Procedure: 9it [00:07,  1.15it/s]████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 345/345 [11:31<00:00,  1.74s/it]
Loss Epoch: 7 Value: 5.0777572050457165
Training Epoch 8: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 345/345 [11:32<00:00,  2.01s/it]
Model Updated: Validation Loss Epoch: 0 Value: 3.3318012952804565 Optimal_loss: 3.3318012952804565
val Procedure: 9it [00:07,  1.16it/s]████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 345/345 [11:32<00:00,  1.74s/it]
Loss Epoch: 8 Value: 4.862614198943893
Training Epoch 9: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 345/345 [11:32<00:00,  2.01s/it]
Model Updated: Validation Loss Epoch: 0 Value: 3.062972068786621 Optimal_loss: 3.062972068786621
val Procedure: 9it [00:07,  1.17it/s]████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 345/345 [11:32<00:00,  1.74s/it]
Loss Epoch: 9 Value: 4.735370837866421
Training Epoch 10: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 345/345 [11:32<00:00,  2.01s/it]
Model Updated: Validation Loss Epoch: 0 Value: 2.760713219642639 Optimal_loss: 2.760713219642639
val Procedure: 9it [00:07,  1.16it/s]████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 345/345 [11:32<00:00,  1.74s/it]
Loss Epoch: 10 Value: 4.651664205774292
Training Epoch 11: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 345/345 [11:32<00:00,  2.01s/it]
val Procedure: 9it [00:07,  1.16it/s]████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 345/345 [11:32<00:00,  1.74s/it]
Loss Epoch: 11 Value: 4.589271009221244
Training Epoch 12: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 345/345 [11:32<00:00,  2.01s/it]
Model Updated: Validation Loss Epoch: 0 Value: 2.731501913070679 Optimal_loss: 2.731501913070679
val Procedure: 9it [00:07,  1.17it/s]████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 345/345 [11:32<00:00,  1.74s/it]
Loss Epoch: 12 Value: 4.5403026554049175
Training Epoch 13: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 345/345 [11:31<00:00,  2.00s/it]
Model Updated: Validation Loss Epoch: 0 Value: 2.696642851829529 Optimal_loss: 2.696642851829529
val Procedure: 9it [00:07,  1.16it/s]████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 345/345 [11:31<00:00,  1.74s/it]
Loss Epoch: 13 Value: 4.502330601994067
Training Epoch 14: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 345/345 [11:32<00:00,  2.01s/it]
Model Updated: Validation Loss Epoch: 0 Value: 2.627514863014221 Optimal_loss: 2.627514863014221
val Procedure: 9it [00:07,  1.17it/s]████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 345/345 [11:32<00:00,  1.74s/it]
Loss Epoch: 14 Value: 4.472262306718159
Training Epoch 15: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 345/345 [11:32<00:00,  2.01s/it]
val Procedure: 9it [00:07,  1.17it/s]████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 345/345 [11:32<00:00,  1.74s/it]
Loss Epoch: 15 Value: 4.4461840163937785
Training Epoch 16: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 345/345 [11:31<00:00,  2.01s/it]
Model Updated: Validation Loss Epoch: 0 Value: 2.46094491481781 Optimal_loss: 2.46094491481781
val Procedure: 9it [00:07,  1.16it/s]████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 345/345 [11:31<00:00,  1.74s/it]
Loss Epoch: 16 Value: 4.4212698466175375
Training Epoch 17: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 345/345 [11:32<00:00,  2.01s/it]
val Procedure: 9it [00:07,  1.16it/s]████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 345/345 [11:32<00:00,  1.74s/it]
Loss Epoch: 17 Value: 4.397341877280902
Training Epoch 18: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 345/345 [11:32<00:00,  2.01s/it]
val Procedure: 9it [00:07,  1.16it/s]████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 345/345 [11:32<00:00,  1.74s/it]
Loss Epoch: 18 Value: 4.375823569759504
Training Epoch 19: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 345/345 [11:32<00:00,  2.01s/it]
val Procedure: 9it [00:07,  1.16it/s]████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 345/345 [11:32<00:00,  1.74s/it]
Loss Epoch: 19 Value: 4.358831157656283
Training Epoch 20: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 345/345 [11:32<00:00,  2.01s/it]
Model Updated: Validation Loss Epoch: 0 Value: 2.4306500911712647 Optimal_loss: 2.4306500911712647
val Procedure: 9it [00:07,  1.17it/s]████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 345/345 [11:32<00:00,  1.74s/it]
Loss Epoch: 20 Value: 4.3453114662098296
Training Procedure:  20%|███████████████████████████▍                                                                                                            | 20/99 [3:53:22<15:23:03, 701.06s/it]                                    Exception in thread Thread-24 (_pin_memory_loop):
Model Updated: Validation Loss Epoch: 0 Value: 2.2720747709274294 Optimal_loss: 2.2720747709274294
Traceback (most recent call last):████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▉                      | 302/345 [10:06<01:26,  2.01s/it]
  File "/home/cboned/miniconda3/envs/graphocr/lib/python3.10/threading.py", line 1016, in _bootstrap_inner
    self.run()
  File "/home/cboned/miniconda3/envs/graphocr/lib/python3.10/threading.py", line 953, in run
    self._target(*self._args, **self._kwargs)
  File "/home/cboned/miniconda3/envs/graphocr/lib/python3.10/site-packages/torch/utils/data/_utils/pin_memory.py", line 59, in _pin_memory_loop
    do_one_step()
  File "/home/cboned/miniconda3/envs/graphocr/lib/python3.10/site-packages/torch/utils/data/_utils/pin_memory.py", line 35, in do_one_step
    r = in_queue.get(timeout=MP_STATUS_CHECK_INTERVAL)
  File "/home/cboned/miniconda3/envs/graphocr/lib/python3.10/multiprocessing/queues.py", line 122, in get
    return _ForkingPickler.loads(res)
  File "/home/cboned/miniconda3/envs/graphocr/lib/python3.10/site-packages/torch/multiprocessing/reductions.py", line 541, in rebuild_storage_fd
    fd = df.detach()
  File "/home/cboned/miniconda3/envs/graphocr/lib/python3.10/multiprocessing/resource_sharer.py", line 57, in detach
    with _resource_sharer.get_connection(self._id) as conn:
  File "/home/cboned/miniconda3/envs/graphocr/lib/python3.10/multiprocessing/resource_sharer.py", line 86, in get_connection
    c = Client(address, authkey=process.current_process().authkey)
  File "/home/cboned/miniconda3/envs/graphocr/lib/python3.10/multiprocessing/connection.py", line 502, in Client
    c = SocketClient(address)
  File "/home/cboned/miniconda3/envs/graphocr/lib/python3.10/multiprocessing/connection.py", line 630, in SocketClient
    s.connect(address)
FileNotFoundError: [Errno 2] No such file or directory
Training Epoch 21:  88%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▉                      | 302/345 [10:07<01:26,  2.01s/it]
Traceback (most recent call last):                                                                                                                                                                     
  File "/home/cboned/Projects/OCR-Koopman/experiment_ocr_lkis_ctc.py", line 475, in <module>
    main(cfg=cfg)
  File "/home/cboned/Projects/OCR-Koopman/experiment_ocr_lkis_ctc.py", line 392, in main
    _, metrics = train_one_epoch(
  File "/home/cboned/Projects/OCR-Koopman/experiment_ocr_lkis_ctc.py", line 180, in train_one_epoch
    pred_size = torch.IntTensor([preds.size(1)] * tokens.shape[0]).to(tokens.device)
KeyboardInterrupt
